<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>System Diagnostic Chart</title>
  <script>
    // Chart.js ë¡œë”© ìƒíƒœ í™•ì¸
    window.addEventListener("error", function (e) {
      if (e.target.tagName === "SCRIPT" && e.target.src.includes("chart.js")) {
        console.error("âŒ Chart.js ë¡œë”© ì‹¤íŒ¨: ", e);
        alert("Chart.jsë¥¼ ë¡œë”©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ chart.js íŒŒì¼ì„ ë¡œì»¬ë¡œ ì œê³µí•´ë³´ì„¸ìš”.^^");
      }
    }, true);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
    }

    form {
      margin-bottom: 20px;
    }

    input[type="file"], button {
      font-size: 1rem;
      padding: 8px;
    }

    canvas {
      border: 1px solid #ccc;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>System Diagnostic Score</h2>

  <form id="uploadForm">
    <input type="file" id="excelFile" accept=".xlsx" required />
    <button type="submit">ì—…ë¡œë“œ ë° ì‹œê°í™”</button>
  </form>
  <br/>
  <canvas id="diagnosticChart" width="800" height="400"></canvas>

  <script>
    async function uploadExcel(file) {
      const formData = new FormData();
      formData.append('file', file);
      const res = await fetch('/upload-excel', {
        method: 'POST',
        body: formData
      });
      const msg = await res.text();
      if (!res.ok) {
        alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + msg);
        console.error("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨ ë©”ì‹œì§€:", msg);
      } else {
        alert("âœ… " + msg);
        console.log("âœ… ì—…ë¡œë“œ ì„±ê³µ:", msg);
      }
    }

    async function loadData() {
      console.log('loadData'); 
      try {
        const response = await fetch('/odata/v4/diagnostic/Diagnostics');
        const data = await response.json();
        console.log("ğŸ“¦ ë¡œë“œëœ OData:", data.value); // ì¶”ê°€ëœ ë””ë²„ê¹… ë¡œê·¸
        return data.value;
      } catch (err) {
        console.error("âŒ OData ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        return [];
      }
    }

    function transformData(raw) {
      const systems = [...new Set(raw.map(d => d.systemType))];
      const areas = [...new Set(raw.map(d => d.area))];
      const datasets = systems.map(system => {
        const data = areas.map(area => {
          const found = raw.find(d => d.systemType === system && d.area === area);
          return found ? found.score : 0;
        });
        return { label: system, data };
      });
      console.log("ğŸ“Š ì°¨íŠ¸ ë°ì´í„° ë³€í™˜ ê²°ê³¼:", { areas, datasets }); // ì¶”ê°€ëœ ë¡œê·¸
      return { areas, datasets };
    }

    async function renderChart() {
      console.log('renderChart'); 
      const raw = await loadData();
      const { areas, datasets } = transformData(raw);
      const ctx = document.getElementById('diagnosticChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: areas, datasets },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      if (file) {
        await uploadExcel(file);
        await renderChart();
      }
    });

    renderChart();
  </script>
</body>
</html>